---
title: "PHI"
output: html_document
date: "2025-03-12"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r}
library(readr)
library(dplyr)
library(stringr)
library(ggplot2)
library(tidyr)

form1human <- read_csv("1-form1human.csv")%>%
  mutate(evaluator= "human")

# Check column names to find the correct column
colnames(form1human)

# Add indicator columns to the original data about which data types were involved
form1human <- form1human %>%
  mutate(Personal_Health_Information = as.integer(str_detect(`Kind of personal data involved in the case (select all that apply). This is the data that is the subject of the dispute.`, "Personal Health Information")))%>%
  mutate(Demographics= as.integer(str_detect(`Kind of personal data involved in the case (select all that apply). This is the data that is the subject of the dispute.`, "Demographics")))%>%
  mutate(Education_or_Licensing= as.integer(str_detect(`Kind of personal data involved in the case (select all that apply). This is the data that is the subject of the dispute.`, "Educational or Professional Licensing Data")))%>%
  mutate(Financial= as.integer(str_detect(`Kind of personal data involved in the case (select all that apply). This is the data that is the subject of the dispute.`, "Financial Data")))%>%
  mutate(Real_Estate= as.integer(str_detect(`Kind of personal data involved in the case (select all that apply). This is the data that is the subject of the dispute.`, "Real Estate Information")))%>%
   mutate(Credit= as.integer(str_detect(`Kind of personal data involved in the case (select all that apply). This is the data that is the subject of the dispute.`, "Credit Information")))%>%
   mutate(Internet_Network= as.integer(str_detect(`Kind of personal data involved in the case (select all that apply). This is the data that is the subject of the dispute.`, "Internet or Network Activity")))%>%
  mutate(Location= as.integer(str_detect(`Kind of personal data involved in the case (select all that apply). This is the data that is the subject of the dispute.`, "Geo-location or GPS Data")))%>%
    mutate(Legal= as.integer(str_detect(`Kind of personal data involved in the case (select all that apply). This is the data that is the subject of the dispute.`, "Legal or Criminal Information")))%>%
    mutate(Online_Social= as.integer(str_detect(`Kind of personal data involved in the case (select all that apply). This is the data that is the subject of the dispute.`, "Social Media or Online Content")))%>%
  mutate(Not_Applicable= as.integer(str_detect(`Kind of personal data involved in the case (select all that apply). This is the data that is the subject of the dispute.`, "Not applicable")))%>%
  mutate(non_HIPAA_Medical= as.integer(str_detect(`Kind of personal data involved in the case (select all that apply). This is the data that is the subject of the dispute.`, "Medical information not covered by HIPAA")))

#Add a column for whether a covered entity was involved or not
form1human <- form1human %>%
  mutate(Covered_Entity_Involved= case_when (
    `Parties Involved. Look at the top of the form for the parties involved in the case.`== "Neither Party is a Covered Entity" ~ "0", 
    `Parties Involved. Look at the top of the form for the parties involved in the case.`== "Individual vs. Healthcare Provider (Covered Entity)" ~ "1", 
    `Parties Involved. Look at the top of the form for the parties involved in the case.`== "Individual vs. Health Insurance Plan (Covered Entity)" ~ "1", 
    `Parties Involved. Look at the top of the form for the parties involved in the case.`== "Government vs. Healthcare Entity (Covered Entity)" ~ "1", 
    `Parties Involved. Look at the top of the form for the parties involved in the case.`== "Business Associate of Covered Entity (Covered Entity)" ~ "1",
    `Parties Involved. Look at the top of the form for the parties involved in the case.`== "Healthcare Provider vs. Healthcare Provider (Covered Entity)" ~ "1",
    .default= "other"
    ))

colnames(form1human)
#Ensure doc ids are lower case
form1human <- form1human %>%
  mutate(`DocumentID (has format doc-x-xx). \n\nWrite \"doc-x-xx\" with the x's having the appropriate numbers for the document you are reviewing. Include the \"doc-\" prefix. Use lowercase letters.` = 
           str_to_lower(`DocumentID (has format doc-x-xx). \n\nWrite \"doc-x-xx\" with the x's having the appropriate numbers for the document you are reviewing. Include the \"doc-\" prefix. Use lowercase letters.`))

```

```{r}
#load in claude model
form1claude<-read_csv("claude_results.csv")%>%
  mutate(Personal_Health_Information = as.integer(str_detect(`kind of personal data involved in the case response`, "personal health information")))%>%
  mutate(Demographics= as.integer(str_detect(`kind of personal data involved in the case response`, "demographics")))%>%
  mutate(Education_or_Licensing= as.integer(str_detect(`kind of personal data involved in the case response`, "educational or professional licensing data")))%>%
  mutate(Financial= as.integer(str_detect(`kind of personal data involved in the case response`, "financial data")))%>%
  mutate(Real_Estate= as.integer(str_detect(`kind of personal data involved in the case response`, "real estate information")))%>%
   mutate(Credit= as.integer(str_detect(`kind of personal data involved in the case response`, "credit information")))%>%
   mutate(Internet_Network= as.integer(str_detect(`kind of personal data involved in the case response`, "internet or network activity")))%>%
  mutate(Location= as.integer(str_detect(`kind of personal data involved in the case response`, "geo-location or gps data")))%>%
    mutate(Legal= as.integer(str_detect(`kind of personal data involved in the case response`, "legal or criminal information")))%>%
    mutate(Online_Social= as.integer(str_detect(`kind of personal data involved in the case response`, "social media or online content")))%>%
  mutate(Not_Applicable= as.integer(str_detect(`kind of personal data involved in the case response`, "not applicable")))%>%
  mutate(non_HIPAA_Medical= as.integer(str_detect(`kind of personal data involved in the case response`, "medical information not covered by hipaa")))

#Add a column for whether a covered entity was involved or not
form1claude <- form1claude %>%
  mutate(Covered_Entity_Involved= case_when (
    `parties involved response`== "neither party is a covered entity" ~ "0", 
    `parties involved response`== "individual vs. healthcare provider" ~ "1", 
    `parties involved response`== "healthcare provider vs. health insurance plan" ~ "1", 
    `parties involved response`== "government vs. healthcare entity" ~ "1", 
    `parties involved response`== "business associate of covered entity" ~ "1",
    `parties involved response`== "healthcare provider vs. healthcare provider" ~ "1",
   `parties involved response`=="health insurance plan vs. healthcare provider"~ "1",
   `parties involved response`=="individual vs. government vs. healthcare entity"~ "1",
   `parties involved response`=="individual vs. health insurance plan"~ "1",
    .default= "other"
    ))
```

```{r}
#Adding gpt dataset
form1gpt <- read_csv("gpt-4o.csv")%>%
  mutate(Personal_Health_Information = as.integer(str_detect(`KindOfPersonalData`, "Personal Health Information")))%>%
  mutate(Demographics= as.integer(str_detect(`KindOfPersonalData`, "Demographics")))%>%
  mutate(Education_or_Licensing= as.integer(str_detect(`KindOfPersonalData`, "Educational or Professional Licensing Data")))%>%
  mutate(Financial= as.integer(str_detect(`KindOfPersonalData`, "Financial Data")))%>%
  mutate(Real_Estate= as.integer(str_detect(`KindOfPersonalData`, "Real Estate Information")))%>%
   mutate(Credit= as.integer(str_detect(`KindOfPersonalData`, "Credit Information")))%>%
   mutate(Internet_Network= as.integer(str_detect(`KindOfPersonalData`, "Internet or Network Activity")))%>%
  mutate(Location= as.integer(str_detect(`KindOfPersonalData`, "Geo-location or GPS Data")))%>%
    mutate(Legal= as.integer(str_detect(`KindOfPersonalData`, "Legal or Criminal Information")))%>%
    mutate(Online_Social= as.integer(str_detect(`KindOfPersonalData`, "Social Media or Online Content")))%>%
  mutate(Not_Applicable= as.integer(str_detect(`KindOfPersonalData`, "Not applicable")))%>%
  mutate(non_HIPAA_Medical= as.integer(str_detect(`KindOfPersonalData`, "Medical information not covered by HIPAA")))

#Add a column for whether a covered entity was involved or not
form1gpt <- form1gpt %>%
  mutate(Covered_Entity_Involved= case_when(
    `PartiesInvolved`== "Neither Party is a Covered Entity" ~ "0", 
    `PartiesInvolved`== "Individual vs. Healthcare Provider (Covered Entity)" ~ "1", 
    `PartiesInvolved`== "Individual vs. Health Insurance Plan (Covered Entity)" ~ "1", 
    `PartiesInvolved`== "Government vs. Healthcare Entity (Covered Entity)" ~ "1", 
    `PartiesInvolved`== "Business Associate of Covered Entity (Covered Entity)" ~ "1",
    `PartiesInvolved`== "Healthcare Provider vs. Healthcare Provider (Covered Entity)" ~ "1",
    .default= "other"
    ))


```

```{r}
form1gpt_mini <- read.csv("gpt-4o-mini.csv")%>%
  mutate(evaluator="gpt_mini")
```


```{r}
form1human_wrangled<-form1human%>%
  rename("docID"="DocumentID (has format doc-x-xx). \n\nWrite \"doc-x-xx\" with the x's having the appropriate numbers for the document you are reviewing. Include the \"doc-\" prefix. Use lowercase letters." )%>%
  #deselect variables that are not of interest to us
  select(-c ("Legal Issue","Document Type","Date of Document or Case","Date of Document or Case", "Something interesting? Potential Problematic Strategic Use of HIPAA. This applies to cases where HIPAA is being used to undermine lawsuits that seeks to assert individual rights (e.g. lawsuits about environmental harms, workplace injuries or drug harms or just feels \"creepy\") [OPTIONAL]", "...9","...10", "...11", "...12","...13","...14", "Type of court.", "Parties Involved. Look at the top of the form for the parties involved in the case.","Kind of personal data involved in the case (select all that apply). This is the data that is the subject of the dispute." ))


form1claude_wrangled<-form1claude%>%
  rename("docID"="document id" )%>%
  select(- c("type of court response","type of court reasoning","parties involved response", "parties involved reasoning","kind of personal data involved in the case response", "kind of personal data involved in the case reasoning","date of document or case response","date of document or case reasoning" ,"document type response",  "document type reasoning" ,"something interesting response", "something interesting reasoning", "does this document contain expert opinions, credentials, or testimony response" ,  "does this document contain expert opinions, credentials, or testimony reasoning"))

form1gpt_wrangled<-form1gpt%>%
  rename("docID"="DocumentID" )%>%
  select(- c("DocumentType", "DateOfDocumentOrCase", "KindOfPersonalData"))%>%
  mutate(evaluator= "gpr-4o")

#make a combined dataset of human and AI evaluations

combined_wrangled_dataset<-bind_rows(form1claude_wrangled, form1human_wrangled, form1gpt_wrangled)%>%
  drop_na(docID)


```


```{r}
#finding what the most frequently reported values are in each column for each unique docid. NOTE: THIS DOES NOT INCLUDE THE GPT MINI

# List of columns to compute majority response
cols_to_summarize <- c("Personal_Health_Information", "Demographics", "Education_or_Licensing", 
                       "Financial", "Real_Estate", "Credit", "Internet_Network", "Location", 
                       "Legal", "Online_Social", "Not_Applicable", "non_HIPAA_Medical", 
                       "Covered_Entity_Involved")

# Function to get majority response or flag even ties
get_majority_or_flag <- function(x) {
  x <- na.omit(x)  # Remove NA values
  if (length(x) == 0) return("Not found- NA")  # If all values are NA
  value_counts <- table(x)
  max_count <- max(value_counts)
  most_frequent <- names(value_counts[value_counts == max_count])
  if (length(most_frequent) > 1) {
    return("Tied Response")
  } else {
    return(most_frequent[1])
  }
}

# Compute majority response per docID (include all docIDs)
majority_response_per_docID <- combined_wrangled_dataset %>%
  group_by(docID) %>%
  summarize(across(all_of(cols_to_summarize), get_majority_or_flag), .groups = "drop")

# View the resulting dataset
head(majority_response_per_docID)

```

```{r}

ggplot(majority_response_per_docID, mapping=aes(x=Personal_Health_Information))+
  geom_bar()

ggplot(majority_response_per_docID, mapping=aes(x=non_HIPAA_Medical))+
  geom_bar()



# Map values for better labeling
majority_response_per_docID <- majority_response_per_docID %>%
  mutate(Covered_Entity_Involved = case_when(
    Covered_Entity_Involved == "0" ~ "No Covered Entities ",
    Covered_Entity_Involved == "1" ~ "At Least One Covered Entity",
    Covered_Entity_Involved == "other" ~ "Other",
    Covered_Entity_Involved == "Tied Response" ~ "Tied Response",
    TRUE ~ Covered_Entity_Involved
  ))

# Create the bar plot
ggplot(majority_response_per_docID, mapping = aes(x = Covered_Entity_Involved)) +
  geom_bar() +
  geom_text(stat = 'count', aes(label = after_stat(count)), vjust = -0.5) +
  labs(title = "Covered Entity Involvement in Cases which Mention HIPAA", 
       x = "Covered Entity Involvement", 
       y = "Count") +
  theme_minimal()


# List of columns to compute majority response
cols_graph_2<- c("Personal_Health_Information", "Demographics", "Education_or_Licensing", 
                       "Financial", "Real_Estate", "Credit", "Internet_Network", "Location", 
                       "Legal", "Online_Social", "Not_Applicable", "non_HIPAA_Medical" )

# Reshape the data for visualization
majority_long <- majority_response_per_docID %>%
  pivot_longer(cols = all_of(cols_graph_2), 
               names_to = "Variable", 
               values_to = "Response")
# Create the proportional bar plot
ggplot(majority_long, aes(x = Variable, fill = Response)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(title = "Proportions of Responses Across Variables",
       x = "Variable",
       y = "Proportion",
       fill = "Response") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


majority_long$Response <- factor(majority_long$Response, 
                                 levels = c( "Tied Response", "0", "1"))
ggplot(majority_long, aes(x = Variable, fill = Response)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_fill_manual(
    values = c("Tied Response" = "lightblue", "0" = "grey", "1" = "darkgreen" ),
    labels = c("0" = "Not Mentioned", "1" = "Mentioned", "Tied Response" = "Tied Response")
  ) +
  labs(title = "Types of Data Involved in Cases Mentioning HIPAA",
       x = "Variable",
       y = "Proportion",
       fill = "Response") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```




```{r}
#THIS WORK WILL FIND MAJORITY RESPONSES WITH THE MINI GPT 40 as well

form1gpt_mini_wrangled<-form1gpt_mini%>%
  rename("docID"="DocumentID" )%>%
  rename("Personal_Health_Information"= "InvolvesPHI")%>%
  rename("Covered_Entity_Involved"= "InvolvesCoveredEntity")%>%
  mutate(Personal_Health_Information= case_when (
    Personal_Health_Information== "True" ~ 1, 
    Personal_Health_Information== "False" ~ 0))%>%
   mutate(Covered_Entity_Involved= case_when (
    Covered_Entity_Involved== "True" ~ "1", 
    Covered_Entity_Involved== "False" ~ "0"))%>%
  select(-Explanation)


combined_dataset_w_mini <- bind_rows(
  select(form1claude_wrangled, docID, evaluator, Personal_Health_Information,Covered_Entity_Involved),
  select(form1human_wrangled, docID, evaluator, Personal_Health_Information, Covered_Entity_Involved),
  select(form1gpt_wrangled, docID, evaluator, Personal_Health_Information, Covered_Entity_Involved),
  select(form1gpt_mini_wrangled, docID, evaluator, Personal_Health_Information, Covered_Entity_Involved)
)

#Find majority responses with the mini gpt included

# Compute majority response per docID (include all docIDs)
majority_responses_w_mini <- combined_dataset_w_mini %>%
  group_by(docID) %>%
  summarize(across(all_of(c("Personal_Health_Information", "Covered_Entity_Involved")), get_majority_or_flag), .groups = "drop")



#Comparing the results when including mini and not
majority_responses_w_mini %>%
  group_by(Personal_Health_Information)%>%
  count()

majority_response_per_docID %>%
  group_by(Personal_Health_Information)%>%
  count()


majority_responses_w_mini %>%
  group_by(Covered_Entity_Involved)%>%
  count()

majority_response_per_docID %>%
  group_by(Covered_Entity_Involved)%>%
  count()
```

